<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.69.0" />

  <title>[docker]elasticSearch/kibana  &middot; nagimemooo</title>

  <meta name="description" content="" />

  

<meta itemprop="name" content="[docker]elasticSearch/kibana ">
<meta itemprop="description" content="本章介紹

建立elasticSearch/kibana [docker]
建立index與傳送資料
查詢資料
">
<meta itemprop="datePublished" content="2020-06-22T15:03:55&#43;08:00" />
<meta itemprop="dateModified" content="2020-06-22T15:03:55&#43;08:00" />
<meta itemprop="wordCount" content="407">
<meta itemprop="image" content="https://nagimemooo.github.io/images/profile.png"/>



<meta itemprop="keywords" content="" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://nagimemooo.github.io/images/profile.png"/>

<meta name="twitter:title" content="[docker]elasticSearch/kibana "/>
<meta name="twitter:description" content="本章介紹

建立elasticSearch/kibana [docker]
建立index與傳送資料
查詢資料
"/>


<meta property="og:title" content="[docker]elasticSearch/kibana " />
<meta property="og:description" content="本章介紹

建立elasticSearch/kibana [docker]
建立index與傳送資料
查詢資料
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nagimemooo.github.io/post/docker_elasticsearch_kibana/" />
<meta property="og:image" content="https://nagimemooo.github.io/images/profile.png"/>
<meta property="article:published_time" content="2020-06-22T15:03:55+08:00" />
<meta property="article:modified_time" content="2020-06-22T15:03:55+08:00" /><meta property="og:site_name" content="Nagi Memo" />



  <link type="text/css"
        rel="stylesheet"
        href="/css/print.css"
        media="print">

  <link type="text/css"
        rel="stylesheet"
        href="/css/poole.css">

  <link type="text/css"
        rel="stylesheet"
        href="/css/hyde.css">

  


  

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
        crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed"
        sizes="144x144"
        href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/favicon.png">

  
  </head>
<body>
  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
        <div class="author-image">
          <img src="/images/profile.png" class="img-circle img-headshot center" alt="Profile Picture">
        </div>
        
      

      <h1>nagimemooo</h1>

      
      <p class="lead">Nagi&#39;s technical memo</p>
      
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li>
          <a href="https://nagimemooo.github.io">Home</a>
        </li>
        <li>
          <a href="/posts/">Posts</a>
        </li><li>
          <a href="/categories/">Categories</a>
        </li><li>
          <a href="/tags/">Tags</a>
        </li><li>
          <a href="/about/">About</a>
        </li>
      </ul>
    </nav>

    <section class="social-icons">
      
    </section>
  </div>
</aside>


  <main class="content container">
  <div class="post">
  <h1>[docker]elasticSearch/kibana </h1>

  <div class="post-date">
    <time datetime="2020-06-22T15:03:55&#43;0800">Jun 22, 2020</time> &middot; 2 min read
  </div>

  <p>本章介紹</p>
<ul>
<li>建立elasticSearch/kibana [docker]</li>
<li>建立index與傳送資料</li>
<li>查詢資料</li>
</ul>
<h3 id="1啟動docker-elasticsearchkibana">1.啟動docker-elasticSearch/kibana</h3>
<ul>
<li>先備知識:docker &amp; docker-compose</li>
<li>先將網路上找到的docker-compose.yml內容編輯好，
然後在一樣的目錄下開啟指令docker-compose up -d
參考</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$docker-compose up -d
WARNING: Some services <span style="color:#f92672">(</span>elasticsearch, kibana<span style="color:#f92672">)</span> use the <span style="color:#e6db74">&#39;deploy&#39;</span> key, which will be ignored. Compose does not support <span style="color:#e6db74">&#39;deploy&#39;</span> configuration - use <span style="color:#e6db74">`</span>docker stack deploy<span style="color:#e6db74">`</span> to deploy to a swarm.
Starting elasticsearch-624 ... <span style="color:#66d9ef">done</span>
Starting kibana-624        ... <span style="color:#66d9ef">done</span>
</code></pre></div><p>需要一點時間，可以用Kitematic之類的工具查看有沒有成功<!-- raw HTML omitted --></p>
<ul>
<li>
<p>GET localhost:9200 確認elasticSearch是否啟動
成功會回版號等資訊 &ldquo;number&rdquo;: &ldquo;6.2.4&rdquo;</p>
</li>
<li>
<p>開啟瀏覽器，確認kibana有無成功
http://127.0.0.1:5601/app/kibana#/home?_g=()</p>
</li>
</ul>
<h3 id="2準備資料與index">2.準備資料與index</h3>
<ul>
<li>先設計資料內容，假設今天要收集一個使用者每天的運動紀錄
這是一個有array的紀錄內容，內容可長可短。</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;user01&#34;</span>,
    <span style="color:#f92672">&#34;timestamp&#34;</span>: <span style="color:#ae81ff">1583734521000</span>,
    <span style="color:#f92672">&#34;records&#34;</span>: [
        {
            <span style="color:#f92672">&#34;record_name&#34;</span>: <span style="color:#e6db74">&#34;heart_rate&#34;</span>,
            <span style="color:#f92672">&#34;data_number&#34;</span>: <span style="color:#ae81ff">80</span>,
            <span style="color:#f92672">&#34;data_txt&#34;</span>: <span style="color:#e6db74">&#34;avg&#34;</span>
        },
        {
            <span style="color:#f92672">&#34;record_name&#34;</span>: <span style="color:#e6db74">&#34;Calories&#34;</span>,
            <span style="color:#f92672">&#34;data_number&#34;</span>: <span style="color:#ae81ff">200</span>
        },
        {
            <span style="color:#f92672">&#34;record_name&#34;</span>: <span style="color:#e6db74">&#34;time_duration&#34;</span>,
            <span style="color:#f92672">&#34;data_number&#34;</span>: <span style="color:#ae81ff">30</span>,
            <span style="color:#f92672">&#34;record_unit&#34;</span>: <span style="color:#e6db74">&#34;min&#34;</span>
        }
    ]
}
</code></pre></div><h4 id="接著新增必須欄位的屬性index">接著新增必須欄位的屬性index</h4>
<ul>
<li>user是一般text,timestamp是date</li>
<li>records先建立nested巢狀，在建立裡面的record_name等欄位。</li>
<li>建立index: PUT localhost:9200/{index}</li>
</ul>
<pre><code>PUT localhost:9200/event
{
    &quot;mappings&quot;: {
        &quot;_doc&quot;: {
            &quot;properties&quot;: {
                &quot;user&quot;: {
                    &quot;type&quot;: &quot;text&quot;,
                    &quot;fields&quot;: {
                        &quot;keyword&quot;: {
                            &quot;type&quot;: &quot;keyword&quot;,
                            &quot;ignore_above&quot;: 256
                        }
                    }
                },
                &quot;id&quot;: {
                    &quot;type&quot;: &quot;text&quot;,
                    &quot;fields&quot;: {
                        &quot;keyword&quot;: {
                            &quot;type&quot;: &quot;keyword&quot;,
                            &quot;ignore_above&quot;: 256
                        }
                    }
                },
                &quot;timestamp&quot;: {
                    &quot;type&quot;: &quot;date&quot;,
                    &quot;format&quot;: &quot;epoch_millis&quot;
                },
                &quot;records&quot;: {
                    &quot;type&quot;: &quot;nested&quot;,
                    &quot;properties&quot;: {
                        &quot;record_name&quot;: {
                            &quot;type&quot;: &quot;text&quot;,
                            &quot;fields&quot;: {
                                &quot;keyword&quot;: {
                                    &quot;type&quot;: &quot;keyword&quot;,
                                    &quot;ignore_above&quot;: 256
                                }
                            }
                        },
                        &quot;data_number&quot;: {
                            &quot;type&quot;: &quot;long&quot;,
                            &quot;fields&quot;: {
                                &quot;keyword&quot;: {
                                    &quot;type&quot;: &quot;keyword&quot;,
                                    &quot;ignore_above&quot;: 256
                                }
                            }
                        },
                        &quot;data_txt&quot;: {
                            &quot;type&quot;: &quot;text&quot;,
                            &quot;fields&quot;: {
                                &quot;keyword&quot;: {
                                    &quot;type&quot;: &quot;keyword&quot;,
                                    &quot;ignore_above&quot;: 256
                                }
                            }
                        },
                        &quot;record_unit&quot;: {
                            &quot;type&quot;: &quot;text&quot;,
                            &quot;fields&quot;: {
                                &quot;keyword&quot;: {
                                    &quot;type&quot;: &quot;keyword&quot;,
                                    &quot;ignore_above&quot;: 256
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
</code></pre><h4 id="送資料進去">送資料進去</h4>
<ul>
<li>接著把上述資料先送一筆進去</li>
<li>http://localhost:9200/{index}/{type}
POST http://localhost:9200/event/_doc</li>
</ul>
<h3 id="kibana建立index">kibana建立index</h3>
<ul>
<li>
<h4 id="建立index">建立index</h4>
</li>
</ul>
<p>Management頁面-&gt;create index-&gt;填入event-&gt;選擇可以做時間分割的欄位名稱{上述是用timestamp}-&gt;按下create index pattern<!-- raw HTML omitted --></p>
<ul>
<li>
<h4 id="discover頁面搜尋資料">Discover頁面搜尋資料</h4>
</li>
</ul>
<p>再送一次資料，這次把 &ldquo;timestamp&rdquo;: {改成現在時間戳}-&gt;線上有很多工具可以做轉換
回到Discover頁面，query最近15分鐘的資料-&gt;就可以看到時間軸了<!-- raw HTML omitted --></p>
<ul>
<li>
<h4 id="visualize-建立感興趣的圖表展示">Visualize 建立感興趣的圖表展示</h4>
</li>
</ul>
<p>ex: table顯示/長條圖顯示等/或是特定filter資料。然後替圖表存檔。<!-- raw HTML omitted --></p>
<ul>
<li>
<h4 id="dashboard-頁面">Dashboard 頁面</h4>
</li>
</ul>
<p>這邊把剛剛建立的圖表拉好顯示在這邊。</p>
<ul>
<li>
<h4 id="dev-tools-頁面">dev tools 頁面</h4>
</li>
</ul>
<p>透過條件指令搜尋特定資料，如有程式需要可以用搜尋API試著找出自己想搜尋的內容</p>
<ul>
<li>size/page/sort 分頁與排序依據</li>
<li>bool query 條件-filter時間/range/match/wildcard等搜尋
<ul>
<li>所有 must 必须匹配，所有 must_not 都必须不匹配</li>
<li>minimum_should_match 參數控制需要匹配的 should 語句的數量</li>
</ul>
</li>
</ul>
<p>範例:</p>
<pre><code>GET /event/_search
{
  &quot;size&quot;: 1000,
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;filter&quot;: {
        &quot;range&quot;: {
          &quot;timestamp&quot;: {
            &quot;from&quot;: 159132465000,
            &quot;include_lower&quot;: true,
            &quot;include_upper&quot;: true,
            &quot;to&quot;: 1591324650099
          }
        }
      },
      &quot;must&quot;: [
        {
          &quot;exists&quot;: {
            &quot;field&quot;: &quot;user&quot;
          }
        },
        {
          &quot;match&quot;: {
            &quot;user&quot;: {
              &quot;operator&quot;: &quot;AND&quot;,
              &quot;query&quot;: &quot;user01&quot;
            }
          }
        },
        {
          &quot;nested&quot;: {
            &quot;path&quot;: &quot;records&quot;,
            &quot;query&quot;: {
              &quot;bool&quot;: {
                &quot;must&quot;: [
                  {
                    &quot;match&quot;: {
                      &quot;records.record_name&quot;: {
                        &quot;operator&quot;: &quot;AND&quot;,
                        &quot;query&quot;: &quot;heart_rate&quot;
                      }
                    }
                  },
                  {
                    &quot;wildcard&quot;: {
                      &quot;records.data_txt&quot;: &quot;*a*&quot;
                    }
                  },
                  {
                    &quot;range&quot;: {
                      &quot;records.data_number&quot;: {
                        &quot;from&quot;: 2,
                        &quot;include_lower&quot;: false,
                        &quot;include_upper&quot;: true,
                        &quot;to&quot;: null
                      }
                    }
                  }
                ]
              }
            }
          }
        }
      ],
      &quot;minimum_should_match&quot;: &quot;1&quot;,
      &quot;should&quot;: [
        {
          &quot;match&quot;: {
            &quot;user&quot;: {
              &quot;operator&quot;: &quot;AND&quot;,
              &quot;query&quot;: &quot;user01&quot;
            }
          }
        },
        {
          &quot;match&quot;: {
            &quot;user&quot;: {
              &quot;operator&quot;: &quot;AND&quot;,
              &quot;query&quot;: &quot;user02&quot;
            }
          }
        }
      ]
    }
  },
  &quot;sort&quot;: [
    {
      &quot;timestamp&quot;: {
        &quot;order&quot;: &quot;desc&quot;
      }
    }
  ]
}

</code></pre><h4 id="參考資料">參考資料</h4>
<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/bool-query.html" title="elastic-組合查詢 中文">elastic-組合查詢 中文</a></p>
</div>


  </main>

  <footer>
  <div>
    &copy; Nagi 2020

    

    &middot; Build with <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://themes.gohugo.io/soho/" target="_blank">Soho</a> theme
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
          integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0="
          crossorigin="anonymous"></script>

  

  
</body>
</html>
