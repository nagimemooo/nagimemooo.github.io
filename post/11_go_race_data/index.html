<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.69.0" />

  <title>[go]使用gorountine時避免資料競爭而輸出不正確結果 &middot; nagimemooo</title>

  <meta name="description" content="" />

  

<meta itemprop="name" content="[go]使用gorountine時避免資料競爭而輸出不正確結果">
<meta itemprop="description" content="
為避免多個goroutine執行發生資料競爭（race condition）會造成結果偶爾會跟想像不同，本章介紹如何簡單避免與檢測方法．
">
<meta itemprop="datePublished" content="2020-06-22T16:43:48&#43;08:00" />
<meta itemprop="dateModified" content="2020-06-22T16:43:48&#43;08:00" />
<meta itemprop="wordCount" content="147">
<meta itemprop="image" content="https://nagimemooo.github.io/images/profile.png"/>



<meta itemprop="keywords" content="golang,race condition,Mutex," />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://nagimemooo.github.io/images/profile.png"/>

<meta name="twitter:title" content="[go]使用gorountine時避免資料競爭而輸出不正確結果"/>
<meta name="twitter:description" content="
為避免多個goroutine執行發生資料競爭（race condition）會造成結果偶爾會跟想像不同，本章介紹如何簡單避免與檢測方法．
"/>


<meta property="og:title" content="[go]使用gorountine時避免資料競爭而輸出不正確結果" />
<meta property="og:description" content="
為避免多個goroutine執行發生資料競爭（race condition）會造成結果偶爾會跟想像不同，本章介紹如何簡單避免與檢測方法．
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nagimemooo.github.io/post/11_go_race_data/" />
<meta property="og:image" content="https://nagimemooo.github.io/images/profile.png"/>
<meta property="article:published_time" content="2020-06-22T16:43:48+08:00" />
<meta property="article:modified_time" content="2020-06-22T16:43:48+08:00" /><meta property="og:site_name" content="Nagi Memo" />



  <link type="text/css"
        rel="stylesheet"
        href="/css/print.css"
        media="print">

  <link type="text/css"
        rel="stylesheet"
        href="/css/poole.css">

  <link type="text/css"
        rel="stylesheet"
        href="/css/hyde.css">

  


  

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
        crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed"
        sizes="144x144"
        href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/favicon.png">

  
  </head>
<body>
  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
        <div class="author-image">
          <img src="/images/profile.png" class="img-circle img-headshot center" alt="Profile Picture">
        </div>
        
      

      <h1>nagimemooo</h1>

      
      <p class="lead">Nagi&#39;s technical memo</p>
      
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li>
          <a href="https://nagimemooo.github.io">Home</a>
        </li>
        <li>
          <a href="/posts/">Posts</a>
        </li><li>
          <a href="/categories/">Categories</a>
        </li><li>
          <a href="/tags/">Tags</a>
        </li><li>
          <a href="/about/">About</a>
        </li>
      </ul>
    </nav>

    <section class="social-icons">
      
    </section>
  </div>
</aside>


  <main class="content container">
  <div class="post">
  <h1>[go]使用gorountine時避免資料競爭而輸出不正確結果</h1>

  <div class="post-date">
    <time datetime="2020-06-22T16:43:48&#43;0800">Jun 22, 2020</time> &middot; 1 min read
  </div>

  <blockquote>
<p>為避免多個goroutine執行發生資料競爭（race condition）會造成結果偶爾會跟想像不同，本章介紹如何簡單避免與檢測方法．</p>
</blockquote>
<h4 id="參考資料">參考資料:</h4>
<ul>
<li><a href="https://www.cnblogs.com/yjf512/p/5144211.html" title="golang中的race检测">golang中的race检测</a></li>
<li><a href="https://ithelp.ithome.com.tw/articles/10188220" title="30天就Go(17)：Goroutines">30天就Go(17)：Goroutines</a></li>
<li><a href="https://ithelp.ithome.com.tw/articles/10203517" title="Go day 20 (race condition、Mutex)">Go day 20 (race condition、Mutex)</a> 避免的兩種方法</li>
<li><a href="https://blog.golang.org/race-detector" title="race-detector|  Go">race-detector|Go</a></li>
</ul>
<h4 id="race-condition">race condition</h4>
<ul>
<li>多個 goroutine 同時執行工作時，如果有存取到共用的變數，會造成每次的結果可能不一致．</li>
<li>Golang有自帶可以檢測競爭危害的功能，運行得時候採用參數-race
go run -race  main.go</li>
</ul>
<p>然後去執行一些程式邏輯，會在過程中產生發生競爭的變數，Log 可能出現在過程中。</p>
<ul>
<li>競爭危害最簡單可以用 Mutex 解決</li>
<li>錯誤標準是會用 default stderr 輸出，如果要把 stderr 的結果輸出到檔案，要用 2&gt; 來把它輸出到檔案 ex: go run -race main.go 2&gt;./out.txt，或者更改env GORACE (但我在win環境設定不出來)</li>
</ul>
<p>範例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">w</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">m</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sum</span> = <span style="color:#ae81ff">0</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
			<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Done</span>()
			<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Lock</span>()
			<span style="color:#a6e22e">sum</span><span style="color:#f92672">++</span>
			<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Unlock</span>()
		}()
		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
			<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Done</span>()
			<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Lock</span>()
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34; sum is&#34;</span>, <span style="color:#a6e22e">sum</span>)
			<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Unlock</span>()
		}()
	}
	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Wait</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;final sum is&#34;</span>, <span style="color:#a6e22e">sum</span>)
}
</code></pre></div><ul>
<li>可以試著把Mutex拿掉，如果有競爭危害會出現以下LOG內容</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">==================</span>
<span style="color:#a6e22e">WARNING</span>: <span style="color:#a6e22e">DATA</span> <span style="color:#a6e22e">RACE</span>
<span style="color:#a6e22e">Read</span> <span style="color:#a6e22e">at</span> <span style="color:#ae81ff">0x00c00016c928</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">10</span>:
  <span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">func2</span>()
      <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#66d9ef">go</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">firstgodemo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">main</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">42</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x6d</span>

<span style="color:#a6e22e">Previous</span> <span style="color:#a6e22e">write</span> <span style="color:#a6e22e">at</span> <span style="color:#ae81ff">0x00c00016c928</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">9</span>:
  <span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">func1</span>()
      <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#66d9ef">go</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">firstgodemo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">main</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">35</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x8d</span>

<span style="color:#a6e22e">Goroutine</span> <span style="color:#ae81ff">10</span> (<span style="color:#a6e22e">running</span>) <span style="color:#a6e22e">created</span> <span style="color:#a6e22e">at</span>:
  <span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">main</span>()
      <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#66d9ef">go</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">firstgodemo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">main</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">40</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x189</span>

<span style="color:#a6e22e">Goroutine</span> <span style="color:#ae81ff">9</span> (<span style="color:#a6e22e">finished</span>) <span style="color:#a6e22e">created</span> <span style="color:#a6e22e">at</span>:
  <span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">main</span>()
      <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#66d9ef">go</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">firstgodemo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">main</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">32</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x146</span>
<span style="color:#f92672">==================</span>
<span style="color:#a6e22e">因為有時候這段訊息會出現在畫面中間</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">可以用以下指定把它輸出到txt中</span><span style="color:#960050;background-color:#1e0010">。</span>
<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">run</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">race</span> <span style="color:#a6e22e">main</span>.<span style="color:#66d9ef">go</span> <span style="color:#ae81ff">2</span>&gt;.<span style="color:#f92672">/</span><span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">txt</span>
<span style="color:#a6e22e">final</span> <span style="color:#a6e22e">sum</span> <span style="color:#a6e22e">is</span> <span style="color:#ae81ff">100</span>
</code></pre></div>
</div>


  </main>

  <footer>
  <div>
    &copy; Nagi 2020

    

    &middot; Build with <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://themes.gohugo.io/soho/" target="_blank">Soho</a> theme
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
          integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0="
          crossorigin="anonymous"></script>

  

  
</body>
</html>
